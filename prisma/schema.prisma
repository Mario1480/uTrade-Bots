generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

enum BotStatus {
  stopped
  running
  error
}

enum FuturesMarginMode {
  isolated
  cross
}

enum EffectivePlan {
  FREE
  PRO
}

enum SubscriptionStatus {
  INACTIVE
  ACTIVE
}

enum BillingProvider {
  CCPAYMENT
}

enum BillingPackageKind {
  PLAN
  AI_TOPUP
  ENTITLEMENT_TOPUP
}

enum BillingOrderStatus {
  PENDING
  PAID
  FAILED
  EXPIRED
}

enum AiLedgerReason {
  MONTHLY_GRANT
  TOPUP
  USAGE_DEBIT
  ADMIN_ADJUST
}

model Bot {
  id                   String           @id @default(uuid())
  name                 String
  symbol               String
  exchange             String
  status               BotStatus        @default(stopped)
  userId               String?
  exchangeAccountId    String?
  lastError            String?
  mmEnabled            Boolean          @default(true)
  volEnabled           Boolean          @default(true)
  priceFollowEnabled   Boolean          @default(false)
  priceSourceExchange  String?
  priceSourceSymbol    String?
  priceSourceType      String           @default("TICKER")
  priceSourceMode      String           @default("CEX")
  dexPriceFeedEnabled  Boolean          @default(false)
  dexChain             String           @default("ethereum")
  dexTokenAddress      String?
  dexCacheTtlMs        Int              @default(3000)
  dexStaleAfterMs      Int              @default(15000)
  dexDeviationEnabled  Boolean          @default(false)
  dexMaxDeviationBps   Int              @default(0)
  dexDeviationPolicy   String           @default("alertOnly")
  dexNotifyCooldownSec Int              @default(300)
  createdAt            DateTime         @default(now())
  updatedAt            DateTime         @updatedAt
  workspaceId          String?
  workspace            Workspace?       @relation(fields: [workspaceId], references: [id])
  user                 User?            @relation(fields: [userId], references: [id])
  exchangeAccount      ExchangeAccount? @relation(fields: [exchangeAccountId], references: [id])

  mmConfig           MarketMakingConfig?
  futuresConfig      FuturesBotConfig?
  volConfig          VolumeConfig?
  riskConfig         RiskConfig?
  notificationConfig BotNotificationConfig?
  priceSupportConfig BotPriceSupportConfig?
  runtime            BotRuntime?
  riskEvents         RiskEvent[]
  alerts             BotAlert[]
  manualTrades       ManualTradeLog[]
  metrics            BotMetric[]
  tradeStates        BotTradeState[]
  tradeHistory       BotTradeHistory[]
}

model FuturesBotConfig {
  id          String            @id @default(uuid())
  botId       String            @unique
  bot         Bot               @relation(fields: [botId], references: [id])
  strategyKey String            @default("dummy")
  marginMode  FuturesMarginMode @default(isolated)
  leverage    Int               @default(1)
  paramsJson  Json              @default("{}")
  tickMs      Int               @default(1000)
  testnet     Boolean           @default(true)
  createdAt   DateTime          @default(now())
  updatedAt   DateTime          @updatedAt
}

model ExchangeAccount {
  id                           String    @id @default(cuid())
  userId                       String
  user                         User      @relation(fields: [userId], references: [id])
  exchange                     String
  label                        String
  apiKeyEnc                    String
  apiSecretEnc                 String
  passphraseEnc                String?
  createdAt                    DateTime  @default(now())
  updatedAt                    DateTime  @updatedAt
  lastUsedAt                   DateTime?
  spotBudgetTotal              Float?
  spotBudgetAvailable          Float?
  futuresBudgetEquity          Float?
  futuresBudgetAvailableMargin Float?
  pnlTodayUsd                  Float?
  lastSyncErrorAt              DateTime?
  lastSyncErrorMessage         String?
  bots                         Bot[]
  riskProfile                  ExchangeAccountRiskProfile?

  @@index([userId, exchange])
}

model ExchangeAccountRiskProfile {
  id                     String          @id @default(cuid())
  exchangeAccountId      String          @unique @map("exchange_account_id")
  exchangeAccount        ExchangeAccount @relation(fields: [exchangeAccountId], references: [id], onDelete: Cascade)
  dailyLossWarnPct       Float           @map("daily_loss_warn_pct")
  dailyLossWarnUsd       Float           @map("daily_loss_warn_usd")
  dailyLossCriticalPct   Float           @map("daily_loss_critical_pct")
  dailyLossCriticalUsd   Float           @map("daily_loss_critical_usd")
  marginWarnPct          Float           @map("margin_warn_pct")
  marginWarnUsd          Float           @map("margin_warn_usd")
  marginCriticalPct      Float           @map("margin_critical_pct")
  marginCriticalUsd      Float           @map("margin_critical_usd")
  createdAt              DateTime        @default(now()) @map("created_at")
  updatedAt              DateTime        @updatedAt @map("updated_at")

  @@map("exchange_account_risk_profiles")
}

model MarketMakingConfig {
  id              String @id @default(uuid())
  botId           String @unique
  bot             Bot    @relation(fields: [botId], references: [id])
  spreadPct       Float
  maxSpreadPct    Float  @default(0.0015)
  levelsUp        Int
  levelsDown      Int
  budgetQuoteUsdt Float
  budgetBaseToken Float
  minOrderUsdt    Float  @default(5)
  maxOrderUsdt    Float  @default(0)
  distribution    String
  jitterPct       Float
  skewFactor      Float
  maxSkew         Float
  mmRepriceMs     Int    @default(15000)
  mmRepricePct    Float  @default(0.01)
  mmPriceEpsPct   Float  @default(0.005)
  mmQtyEpsPct     Float  @default(0.02)
  mmInvAlpha      Float  @default(0.1)
}

model VolumeConfig {
  id                 String @id @default(uuid())
  botId              String @unique
  bot                Bot    @relation(fields: [botId], references: [id])
  dailyNotionalUsdt  Float
  minTradeUsdt       Float
  maxTradeUsdt       Float
  activeFrom         String
  activeTo           String
  mode               String
  buyPct             Float  @default(0.5)
  buyBumpTicks       Float  @default(0)
  sellBumpTicks      Float  @default(0)
  volCooldownMs      Int    @default(60000)
  volActiveTtlMs     Int    @default(20000)
  volMmSafetyMult    Float  @default(1.5)
  volLastBandPct     Float  @default(0.0001)
  volInsideSpreadPct Float  @default(0.00005)
  volLastMinBumpAbs  Float  @default(0.00000001)
  volLastMinBumpPct  Float  @default(0)
  volBuyTicks        Int    @default(2)
  volSellTicks       Int    @default(2)
}

model RiskConfig {
  id              String @id @default(uuid())
  botId           String @unique
  bot             Bot    @relation(fields: [botId], references: [id])
  minUsdt         Float
  maxDeviationPct Float
  maxOpenOrders   Int
  maxDailyLoss    Float
}

model BotNotificationConfig {
  id               String  @id @default(uuid())
  botId            String  @unique
  bot              Bot     @relation(fields: [botId], references: [id])
  fundsWarnEnabled Boolean @default(true)
  fundsWarnPct     Float   @default(0.1)
}

model BotRuntime {
  botId              String    @id
  bot                Bot       @relation(fields: [botId], references: [id])
  updatedAt          DateTime  @updatedAt
  status             String
  reason             String?
  workerId           String?
  lastHeartbeatAt    DateTime?
  lastTickAt         DateTime?
  stateJson          Json?
  lastError          String?
  consecutiveErrors  Int       @default(0)
  errorWindowStartAt DateTime?
  lastErrorAt        DateTime?
  lastErrorMessage   String?
  lastHealthyAt      DateTime?

  mid Float?
  bid Float?
  ask Float?

  // total open orders (all types)
  openOrders Int?

  // separated counts
  openOrdersMm  Int?
  openOrdersVol Int?

  // last passive volume order (clientOrderId like vol-<ts>)
  lastVolClientOrderId String?

  freeUsdt Float?
  freeBase Float?

  tradedNotionalToday Float?

  midCex        Float?
  midDex        Float?
  dexStatus     String?
  dexDiffBps    Float?
  dexLastUpdate DateTime?
}

model BotTradeState {
  id                 String   @id @default(cuid())
  botId              String   @map("bot_id")
  symbol             String
  lastPredictionHash String?  @map("last_prediction_hash")
  lastSignal         String?  @map("last_signal")
  lastSignalTs       DateTime? @map("last_signal_ts")
  lastTradeTs        DateTime? @map("last_trade_ts")
  dailyTradeCount    Int      @default(0) @map("daily_trade_count")
  dailyResetUtc      DateTime @map("daily_reset_utc")
  openSide           String?  @map("open_side")
  openQty            Float?   @map("open_qty")
  openEntryPrice     Float?   @map("open_entry_price")
  openTs             DateTime? @map("open_ts")
  createdAt          DateTime @default(now()) @map("created_at")
  updatedAt          DateTime @updatedAt @map("updated_at")

  bot Bot @relation(fields: [botId], references: [id], onDelete: Cascade)

  @@unique([botId, symbol])
  @@index([botId])
  @@index([botId, dailyResetUtc])
  @@map("bot_trade_state")
}

model BotTradeHistory {
  id                   String   @id @default(cuid())
  botId                String   @map("bot_id")
  userId               String   @map("user_id")
  exchangeAccountId    String   @map("exchange_account_id")
  symbol               String
  marketType           String   @default("perp") @map("market_type")
  side                 String
  status               String   @default("open")
  entryTs              DateTime @map("entry_ts")
  entryPrice           Float    @map("entry_price")
  entryQty             Float    @map("entry_qty")
  entryNotionalUsd     Float    @map("entry_notional_usd")
  tpPrice              Float?   @map("tp_price")
  slPrice              Float?   @map("sl_price")
  exitTs               DateTime? @map("exit_ts")
  exitPrice            Float?   @map("exit_price")
  exitNotionalUsd      Float?   @map("exit_notional_usd")
  realizedPnlUsd       Float?   @map("realized_pnl_usd")
  realizedPnlPct       Float?   @map("realized_pnl_pct")
  outcome              String?  @map("outcome")
  exitReason           String?  @map("exit_reason")
  entryOrderId         String?  @map("entry_order_id")
  exitOrderId          String?  @map("exit_order_id")
  predictionStateId    String?  @map("prediction_state_id")
  predictionHash       String?  @map("prediction_hash")
  predictionSignal     String?  @map("prediction_signal")
  predictionConfidence Float?   @map("prediction_confidence")
  predictionTagsJson   Json?    @map("prediction_tags_json")
  createdAt            DateTime @default(now()) @map("created_at")
  updatedAt            DateTime @updatedAt @map("updated_at")

  bot Bot @relation(fields: [botId], references: [id], onDelete: Cascade)

  @@index([botId, entryTs(sort: Desc)])
  @@index([botId, status])
  @@index([userId, entryTs(sort: Desc)])
  @@index([botId, symbol, status])
  @@map("bot_trade_history")
}

model RiskEvent {
  id        String   @id @default(cuid())
  botId     String
  type      String
  message   String?
  meta      Json?
  createdAt DateTime @default(now())
  bot       Bot      @relation(fields: [botId], references: [id])

  @@index([botId, createdAt])
  @@index([type, createdAt])
}

model BotMetric {
  id                  String   @id @default(cuid())
  botId               String
  bot                 Bot      @relation(fields: [botId], references: [id])
  ts                  DateTime @default(now())
  mid                 Float?
  bid                 Float?
  ask                 Float?
  spreadPct           Float?
  openOrders          Int?
  freeQuote           Float?
  freeBase            Float?
  inventoryQuoteValue Float?
  tradedNotionalToday Float?
  mmOrders            Int?
  volOrders           Int?
  status              String?
  reason              String?

  @@index([ts])
  @@index([botId, ts])
}

model CexConfig {
  id        String   @id @default(uuid())
  exchange  String   @unique
  apiKey    String
  apiSecret String
  apiMemo   String?
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

model AlertConfig {
  key              String   @id @default("default")
  telegramBotToken String?
  telegramChatId   String?
  createdAt        DateTime @default(now())
  updatedAt        DateTime @updatedAt
}

model BotAlert {
  id        String   @id @default(cuid())
  botId     String
  level     String
  title     String
  message   String?
  createdAt DateTime @default(now())
  bot       Bot      @relation(fields: [botId], references: [id])

  @@index([botId, createdAt])
}

model ManualTradeLog {
  id              String   @id @default(cuid())
  workspaceId     String
  userId          String
  botId           String
  symbol          String
  type            String
  side            String
  qty             Float?
  price           Float?
  notional        Float?
  postOnly        Boolean?
  timeInForce     String?
  clientOrderId   String?
  exchangeOrderId String?
  status          String
  error           String?
  createdAt       DateTime @default(now())

  workspace Workspace @relation(fields: [workspaceId], references: [id])
  user      User      @relation(fields: [userId], references: [id])
  bot       Bot       @relation(fields: [botId], references: [id])

  @@index([botId, createdAt])
  @@index([userId, createdAt])
}

model BotFillCursor {
  id                  String   @id @default(cuid())
  botId               String
  symbol              String
  dayKey              String
  tradedNotionalToday Float    @default(0)
  lastTradeTimeMs     BigInt?
  updatedAt           DateTime @updatedAt

  @@unique([botId, symbol, dayKey])
  @@index([botId, symbol, dayKey])
}

model BotFillSeen {
  id        String   @id @default(cuid())
  botId     String
  symbol    String
  tradeId   String
  createdAt DateTime @default(now())

  @@unique([botId, symbol, tradeId])
  @@index([botId, symbol])
}

model BotOrderMap {
  id            String   @id @default(cuid())
  botId         String
  symbol        String
  orderId       String
  clientOrderId String
  createdAt     DateTime @default(now())

  @@unique([botId, symbol, orderId])
  @@index([botId, symbol, clientOrderId])
}

model User {
  id                 String            @id @default(cuid())
  email              String            @unique
  passwordHash       String?
  emailVerifiedAt    DateTime?
  telegramChatId     String?           @unique
  autoLogoutEnabled  Boolean           @default(true)
  autoLogoutMinutes  Int               @default(60)
  allowManualTrading Boolean           @default(false)
  createdAt          DateTime          @default(now())
  updatedAt          DateTime          @updatedAt
  sessions           Session[]
  bots               Bot[]
  exchangeAccounts   ExchangeAccount[]
  reauths            ReauthSession[]
  reauthOtps         ReauthOtp[]
  workspaces         WorkspaceMember[]
  manualTrades       ManualTradeLog[]
  configPresets      BotConfigPreset[]
  auditEvents        AuditEvent[]
  dashboardPerformanceSnapshots DashboardPerformanceSnapshot[]
  aiPromptTemplates  UserAiPromptTemplate[]
  aiTraceLogs        AiTraceLog[]
  subscription       UserSubscription?
  billingOrders      BillingOrder[]
  aiTokenLedger      AiTokenLedger[]
  capacityGrants     SubscriptionCapacityGrant[]
}

model UserSubscription {
  id                     String             @id @default(cuid())
  userId                 String             @unique @map("user_id")
  user                   User               @relation(fields: [userId], references: [id], onDelete: Cascade)
  effectivePlan          EffectivePlan      @default(FREE) @map("effective_plan")
  status                 SubscriptionStatus @default(INACTIVE)
  proValidUntil          DateTime?          @map("pro_valid_until")
  maxRunningBots         Int                @default(1) @map("max_running_bots")
  maxBotsTotal           Int                @default(2) @map("max_bots_total")
  maxRunningPredictionsAi Int?              @map("max_running_predictions_ai")
  maxPredictionsAiTotal  Int?               @map("max_predictions_ai_total")
  maxRunningPredictionsComposite Int?       @map("max_running_predictions_composite")
  maxPredictionsCompositeTotal Int?         @map("max_predictions_composite_total")
  allowedExchanges       String[]           @default(["*"]) @map("allowed_exchanges")
  aiTokenBalance         BigInt             @default(0) @map("ai_token_balance")
  aiTokenUsedLifetime    BigInt             @default(0) @map("ai_token_used_lifetime")
  monthlyAiTokensIncluded BigInt            @default(0) @map("monthly_ai_tokens_included")
  createdAt              DateTime           @default(now()) @map("created_at")
  updatedAt              DateTime           @updatedAt @map("updated_at")

  orders BillingOrder[]
  tokenLedger AiTokenLedger[]
  capacityGrants SubscriptionCapacityGrant[]

  @@index([effectivePlan, proValidUntil], map: "user_subscriptions_plan_valid_until_idx")
  @@map("user_subscriptions")
}

model BillingPackage {
  id               String             @id @default(cuid())
  code             String             @unique
  name             String
  description      String?
  kind             BillingPackageKind
  isActive         Boolean            @default(true) @map("is_active")
  sortOrder        Int                @default(0) @map("sort_order")
  currency         String             @default("USD")
  priceCents       Int                @default(0) @map("price_cents")
  billingMonths    Int                @default(1) @map("billing_months")
  plan             EffectivePlan?     @default(PRO)
  maxRunningBots   Int?               @map("max_running_bots")
  maxBotsTotal     Int?               @map("max_bots_total")
  maxRunningPredictionsAi Int?        @map("max_running_predictions_ai")
  maxPredictionsAiTotal Int?          @map("max_predictions_ai_total")
  maxRunningPredictionsComposite Int? @map("max_running_predictions_composite")
  maxPredictionsCompositeTotal Int?   @map("max_predictions_composite_total")
  allowedExchanges String[]           @default(["*"]) @map("allowed_exchanges")
  monthlyAiTokens  BigInt             @default(0) @map("monthly_ai_tokens")
  topupAiTokens    BigInt             @default(0) @map("topup_ai_tokens")
  topupRunningBots Int?               @map("topup_running_bots")
  topupBotsTotal   Int?               @map("topup_bots_total")
  topupRunningPredictionsAi Int?      @map("topup_running_predictions_ai")
  topupPredictionsAiTotal Int?        @map("topup_predictions_ai_total")
  topupRunningPredictionsComposite Int? @map("topup_running_predictions_composite")
  topupPredictionsCompositeTotal Int? @map("topup_predictions_composite_total")
  meta             Json?
  createdAt        DateTime           @default(now()) @map("created_at")
  updatedAt        DateTime           @updatedAt @map("updated_at")

  orders BillingOrder[]
  orderItems BillingOrderItem[]

  @@index([kind, isActive, sortOrder], map: "billing_packages_kind_active_sort_idx")
  @@map("billing_packages")
}

model BillingOrder {
  id                 String            @id @default(cuid())
  provider           BillingProvider
  userId             String            @map("user_id")
  user               User              @relation(fields: [userId], references: [id], onDelete: Cascade)
  subscriptionId     String?           @map("subscription_id")
  subscription       UserSubscription? @relation(fields: [subscriptionId], references: [id], onDelete: SetNull)
  packageId          String            @map("package_id")
  pkg                BillingPackage    @relation(fields: [packageId], references: [id], onDelete: Restrict)
  merchantOrderId    String            @unique @map("merchant_order_id")
  status             BillingOrderStatus @default(PENDING)
  amountCents        Int               @map("amount_cents")
  currency           String            @default("USD")
  payUrl             String?           @map("pay_url")
  externalOrderId    String?           @map("external_order_id")
  paymentStatusRaw   String?           @map("payment_status_raw")
  paidAt             DateTime?         @map("paid_at")
  expiresAt          DateTime?         @map("expires_at")
  createPayload      Json?             @map("create_payload")
  createResponse     Json?             @map("create_response")
  createdAt          DateTime          @default(now()) @map("created_at")
  updatedAt          DateTime          @updatedAt @map("updated_at")

  items BillingOrderItem[]
  tokenLedger AiTokenLedger[]
  capacityGrants SubscriptionCapacityGrant[]

  @@index([userId, createdAt(sort: Desc)], map: "billing_orders_user_created_idx")
  @@index([status, createdAt(sort: Desc)], map: "billing_orders_status_created_idx")
  @@map("billing_orders")
}

model BillingOrderItem {
  id              String            @id @default(cuid())
  orderId         String            @map("order_id")
  order           BillingOrder      @relation(fields: [orderId], references: [id], onDelete: Cascade)
  packageId       String            @map("package_id")
  pkg             BillingPackage    @relation(fields: [packageId], references: [id], onDelete: Restrict)
  quantity        Int               @default(1)
  unitPriceCents  Int               @map("unit_price_cents")
  lineAmountCents Int               @map("line_amount_cents")
  currency        String            @default("USD")
  kindSnapshot    BillingPackageKind @map("kind_snapshot")
  packageSnapshot Json?             @map("package_snapshot")
  createdAt       DateTime          @default(now()) @map("created_at")

  @@index([orderId], map: "billing_order_items_order_idx")
  @@index([packageId], map: "billing_order_items_package_idx")
  @@map("billing_order_items")
}

model SubscriptionCapacityGrant {
  id                         String            @id @default(cuid())
  userId                     String            @map("user_id")
  user                       User              @relation(fields: [userId], references: [id], onDelete: Cascade)
  subscriptionId             String?           @map("subscription_id")
  subscription               UserSubscription? @relation(fields: [subscriptionId], references: [id], onDelete: SetNull)
  orderId                    String?           @map("order_id")
  order                      BillingOrder?     @relation(fields: [orderId], references: [id], onDelete: SetNull)
  planScope                  EffectivePlan?    @map("plan_scope")
  deltaRunningBots           Int               @default(0) @map("delta_running_bots")
  deltaBotsTotal             Int               @default(0) @map("delta_bots_total")
  deltaRunningPredictionsAi  Int               @default(0) @map("delta_running_predictions_ai")
  deltaPredictionsAiTotal    Int               @default(0) @map("delta_predictions_ai_total")
  deltaRunningPredictionsComposite Int         @default(0) @map("delta_running_predictions_composite")
  deltaPredictionsCompositeTotal Int           @default(0) @map("delta_predictions_composite_total")
  validUntil                 DateTime?         @map("valid_until")
  createdAt                  DateTime          @default(now()) @map("created_at")

  @@index([userId, validUntil], map: "subscription_capacity_grants_user_valid_idx")
  @@index([subscriptionId], map: "subscription_capacity_grants_subscription_idx")
  @@index([orderId], map: "subscription_capacity_grants_order_idx")
  @@map("subscription_capacity_grants")
}

model BillingWebhookEvent {
  id              String          @id @default(cuid())
  provider        BillingProvider
  recordId        String          @unique @map("record_id")
  merchantOrderId String          @map("merchant_order_id")
  payload         Json
  receivedAt      DateTime        @default(now()) @map("received_at")

  @@index([merchantOrderId], map: "billing_webhook_events_merchant_idx")
  @@map("billing_webhook_events")
}

model AiTokenLedger {
  id             String            @id @default(cuid())
  userId         String            @map("user_id")
  user           User              @relation(fields: [userId], references: [id], onDelete: Cascade)
  subscriptionId String?           @map("subscription_id")
  subscription   UserSubscription? @relation(fields: [subscriptionId], references: [id], onDelete: SetNull)
  orderId        String?           @map("order_id")
  order          BillingOrder?     @relation(fields: [orderId], references: [id], onDelete: SetNull)
  reason         AiLedgerReason
  deltaTokens    BigInt            @map("delta_tokens")
  balanceAfter   BigInt            @map("balance_after")
  meta           Json?
  createdAt      DateTime          @default(now()) @map("created_at")

  @@index([userId, createdAt(sort: Desc)], map: "ai_token_ledger_user_created_idx")
  @@index([reason, createdAt(sort: Desc)], map: "ai_token_ledger_reason_created_idx")
  @@map("ai_token_ledger")
}

model DashboardPerformanceSnapshot {
  id                 String   @id @default(cuid())
  userId             String   @map("user_id")
  user               User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  bucketTs           DateTime @map("bucket_ts")
  totalEquity        Float    @map("total_equity")
  totalAvailableMargin Float  @map("total_available_margin")
  totalTodayPnl      Float    @map("total_today_pnl")
  includedAccounts   Int      @map("included_accounts")
  createdAt          DateTime @default(now()) @map("created_at")
  updatedAt          DateTime @updatedAt @map("updated_at")

  @@unique([userId, bucketTs])
  @@index([userId, bucketTs(sort: Desc)], map: "dashboard_perf_user_bucket_desc_idx")
  @@map("dashboard_performance_snapshots")
}

model Session {
  id           String   @id @default(cuid())
  userId       String
  tokenHash    String   @unique
  createdAt    DateTime @default(now())
  lastActiveAt DateTime @default(now())
  expiresAt    DateTime
  user         User     @relation(fields: [userId], references: [id])

  @@index([userId, expiresAt])
}

model ReauthSession {
  id        String   @id @default(cuid())
  userId    String
  tokenHash String   @unique
  createdAt DateTime @default(now())
  expiresAt DateTime
  user      User     @relation(fields: [userId], references: [id])

  @@index([userId, expiresAt])
}

model ReauthOtp {
  id        String   @id @default(cuid())
  userId    String
  purpose   String
  codeHash  String
  createdAt DateTime @default(now())
  expiresAt DateTime
  user      User     @relation(fields: [userId], references: [id])

  @@index([userId, expiresAt])
}

model Workspace {
  id            String            @id @default(cuid())
  name          String
  features      Json?             @default("{}")
  createdAt     DateTime          @default(now())
  members       WorkspaceMember[]
  bots          Bot[]
  manualTrades  ManualTradeLog[]
  roles         Role[]
  configPresets BotConfigPreset[]
  auditEvents   AuditEvent[]
  licenseEntitlement LicenseEntitlement?
}

model BotPriceSupportConfig {
  id                        String  @id @default(uuid())
  botId                     String  @unique
  bot                       Bot     @relation(fields: [botId], references: [id])
  enabled                   Boolean @default(false)
  active                    Boolean @default(true)
  floorPrice                Float?
  budgetUsdt                Float   @default(0)
  spentUsdt                 Float   @default(0)
  maxOrderUsdt              Float   @default(50)
  cooldownMs                Int     @default(2000)
  mode                      String  @default("PASSIVE")
  lastActionAt              BigInt  @default(0)
  stoppedReason             String?
  notifiedBudgetExhaustedAt BigInt  @default(0)
}

model BotConfigPreset {
  id              String   @id @default(cuid())
  workspaceId     String
  name            String
  description     String?
  scope           String   @default("WORKSPACE")
  exchange        String?
  symbol          String?
  payload         Json
  createdByUserId String
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  workspace Workspace @relation(fields: [workspaceId], references: [id])
  createdBy User      @relation(fields: [createdByUserId], references: [id])

  @@unique([workspaceId, name])
  @@index([workspaceId, exchange, symbol])
}

model WorkspaceMember {
  id          String   @id @default(cuid())
  workspaceId String
  userId      String
  roleId      String
  status      String   @default("ACTIVE")
  createdAt   DateTime @default(now())

  workspace Workspace @relation(fields: [workspaceId], references: [id])
  user      User      @relation(fields: [userId], references: [id])
  role      Role      @relation(fields: [roleId], references: [id])

  @@unique([workspaceId, userId])
  @@index([userId])
  @@index([workspaceId, roleId])
}

model Role {
  id          String   @id @default(cuid())
  workspaceId String
  name        String
  isSystem    Boolean  @default(false)
  permissions Json     @default("{}")
  createdAt   DateTime @default(now())

  workspace Workspace         @relation(fields: [workspaceId], references: [id])
  members   WorkspaceMember[]

  @@unique([workspaceId, name])
}

model AuditEvent {
  id          String   @id @default(cuid())
  workspaceId String
  actorUserId String
  action      String
  entityType  String
  entityId    String?
  meta        Json?
  ip          String?
  createdAt   DateTime @default(now())

  workspace Workspace @relation(fields: [workspaceId], references: [id])
  actor     User      @relation(fields: [actorUserId], references: [id])

  @@index([workspaceId, createdAt])
}

model GlobalSetting {
  key       String   @id
  value     Json?
  updatedAt DateTime @updatedAt
}

model UserAiPromptTemplate {
  id                         String   @id @default(cuid())
  userId                     String   @map("user_id")
  user                       User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  name                       String
  promptText                 String   @map("prompt_text")
  indicatorKeys              String[] @map("indicator_keys")
  ohlcvBars                  Int      @default(100) @map("ohlcv_bars")
  timeframes                 String[] @default([])
  runTimeframe               String?  @map("run_timeframe")
  timeframe                  String?
  directionPreference        String   @default("either") @map("direction_preference")
  confidenceTargetPct        Float    @default(60) @map("confidence_target_pct")
  slTpSource                 String   @default("local") @map("sl_tp_source")
  newsRiskMode               String   @default("off") @map("news_risk_mode")
  marketAnalysisUpdateEnabled Boolean @default(false) @map("market_analysis_update_enabled")
  isPublic                   Boolean  @default(false) @map("is_public")
  createdAt                  DateTime @default(now()) @map("created_at")
  updatedAt                  DateTime @updatedAt @map("updated_at")

  @@index([userId, updatedAt(sort: Desc)], map: "user_ai_prompt_templates_user_updated_idx")
  @@index([userId, isPublic], map: "user_ai_prompt_templates_user_public_idx")
  @@map("user_ai_prompt_templates")
}

model LicenseEntitlement {
  id                String   @id @default(cuid())
  workspaceId       String   @unique @map("workspace_id")
  plan              String   @default("pro")
  allowedStrategyKinds String[] @default(["local", "ai", "composite"]) @map("allowed_strategy_kinds")
  allowedStrategyIds String[]  @default([]) @map("allowed_strategy_ids")
  maxCompositeNodes Int      @default(12) @map("max_composite_nodes")
  aiAllowedModels   String[]  @default([]) @map("ai_allowed_models")
  aiMonthlyBudgetUsd Float?  @map("ai_monthly_budget_usd")
  createdAt         DateTime @default(now()) @map("created_at")
  updatedAt         DateTime @updatedAt @map("updated_at")

  workspace Workspace @relation(fields: [workspaceId], references: [id], onDelete: Cascade)

  @@index([plan], map: "license_entitlements_plan_idx")
  @@map("license_entitlements")
}

model RunnerStatus {
  id          String   @id @default("main")
  updatedAt   DateTime @updatedAt
  lastTickAt  DateTime
  botsRunning Int
  botsErrored Int
  version     String?
}

model Prediction {
  id                 String    @id @default(cuid())
  userId             String?
  botId              String?
  symbol             String
  marketType         String
  timeframe          String
  tsCreated          DateTime
  signal             String
  expectedMovePct    Float
  confidence         Float
  explanation        String
  tags               Json
  featuresSnapshot   Json
  entryPrice         Float?
  stopLossPrice      Float?
  takeProfitPrice    Float?
  horizonMs          Int?
  outcomeStatus      String    @default("pending")
  outcomeResult      String?
  outcomeReason      String?
  outcomePnlPct      Float?
  maxFavorablePct    Float?
  maxAdversePct      Float?
  outcomeEvaluatedAt DateTime?
  outcomeMeta        Json?
  modelVersion       String
  createdAt          DateTime  @default(now())
  updatedAt          DateTime  @updatedAt

  @@index([symbol, timeframe, tsCreated])
  @@index([userId, createdAt])
  @@index([botId, createdAt])
  @@index([userId, outcomeStatus, createdAt])
}

model FeatureThreshold {
  id             String   @id @default(uuid())
  exchange       String
  accountScope   String   @default("global") @map("account_scope")
  symbol         String
  marketType     String   @map("market_type")
  timeframe      String
  windowFrom     DateTime @map("window_from")
  windowTo       DateTime @map("window_to")
  nBars          Int      @map("n_bars")
  thresholdsJson Json     @map("thresholds_json")
  computedAt     DateTime @default(now()) @map("computed_at")
  version        String

  @@index([exchange, symbol, marketType, timeframe, computedAt(sort: Desc)])
  @@map("feature_thresholds")
}

model MarketContextSnapshot {
  id             String   @id @default(uuid())
  exchange       String
  symbol         String
  marketType     String   @map("market_type")
  timeframe      String
  tsFrom         DateTime @map("ts_from")
  tsTo           DateTime @map("ts_to")
  contextVersion String   @map("context_version")
  contextHash    String   @map("context_hash")
  payload        Json
  createdAt      DateTime @default(now()) @map("created_at")
  updatedAt      DateTime @updatedAt @map("updated_at")

  @@unique([exchange, symbol, marketType, timeframe])
  @@index([exchange, symbol, marketType, timeframe, contextHash], map: "market_ctx_scope_hash_idx")
  @@index([exchange, symbol, marketType, timeframe, tsTo(sort: Desc)], map: "market_ctx_scope_ts_to_desc_idx")
  @@map("market_context_snapshots")
}

model EconomicCalendarConfig {
  key         String   @id @default("default")
  enabled     Boolean  @default(true)
  enforceNewsRiskBlock Boolean @default(false) @map("enforce_news_risk_block")
  impactMin   String   @default("high") @map("impact_min")
  currencies  String?
  preMinutes  Int      @default(30) @map("pre_minutes")
  postMinutes Int      @default(30) @map("post_minutes")
  provider    String   @default("fmp")
  createdAt   DateTime @default(now()) @map("created_at")
  updatedAt   DateTime @updatedAt @map("updated_at")

  @@map("economic_calendar_config")
}

model EconomicEvent {
  id        String   @id @default(cuid())
  sourceId  String   @map("source_id")
  ts        DateTime
  country   String
  currency  String
  title     String
  impact    String
  forecast  Float?
  previous  Float?
  actual    Float?
  source    String   @default("fmp")
  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  @@unique([source, sourceId])
  @@index([ts])
  @@index([currency, ts])
  @@map("economic_events")
}

model PredictionState {
  id                  String    @id @default(uuid())
  exchange            String
  accountId           String    @map("account_id")
  userId              String    @map("user_id")
  symbol              String
  marketType          String    @map("market_type")
  timeframe           String
  signalMode          String    @default("both") @map("signal_mode")
  strategyKind        String    @default("legacy") @map("strategy_kind")
  strategyId          String    @default("legacy") @map("strategy_id")
  tsUpdated           DateTime  @map("ts_updated")
  tsPredictedFor      DateTime  @map("ts_predicted_for")
  signal              String
  expectedMovePct     Float?    @map("expected_move_pct")
  confidence          Float
  tags                Json
  explanation         String?
  keyDrivers          Json      @map("key_drivers")
  featuresSnapshot    Json      @map("features_snapshot")
  modelVersion        String    @map("model_version")
  lastAiExplainedAt   DateTime? @map("last_ai_explained_at")
  aiGateLastDecisionHash         String?   @map("ai_gate_last_decision_hash")
  aiGateLastExplainedPredictionHash String? @map("ai_gate_last_explained_prediction_hash")
  aiGateLastExplainedHistoryHash String?   @map("ai_gate_last_explained_history_hash")
  aiGateLastReasonCodes          Json?     @map("ai_gate_last_reason_codes")
  aiGateLastPriority             String?   @map("ai_gate_last_priority")
  aiGateWindowStartedAt          DateTime? @map("ai_gate_window_started_at")
  aiGateCallsLastHour            Int       @default(0) @map("ai_gate_calls_last_hour")
  aiGateHighPriorityCallsLastHour Int      @default(0) @map("ai_gate_high_priority_calls_last_hour")
  lastChangeHash      String?   @map("last_change_hash")
  lastChangeReason    String?   @map("last_change_reason")
  autoScheduleEnabled Boolean   @default(true) @map("auto_schedule_enabled")
  autoSchedulePaused  Boolean   @default(false) @map("auto_schedule_paused")
  directionPreference String?   @map("direction_preference")
  confidenceTargetPct Float?    @map("confidence_target_pct")
  leverage            Int?
  createdAt           DateTime  @default(now()) @map("created_at")
  updatedAt           DateTime  @updatedAt @map("updated_at")

  events PredictionEvent[]

  @@unique([exchange, accountId, symbol, marketType, timeframe, signalMode, strategyKind, strategyId])
  @@index([exchange, accountId, timeframe, tsUpdated(sort: Desc)])
  @@index([symbol, timeframe, tsUpdated(sort: Desc)])
  @@index([userId, updatedAt(sort: Desc)])
  @@map("predictions_state")
}

model PredictionEvent {
  id             String   @id @default(uuid())
  stateId        String   @map("state_id")
  tsCreated      DateTime @default(now()) @map("ts_created")
  changeType     String   @map("change_type")
  prevSnapshot   Json?    @map("prev_snapshot")
  newSnapshot    Json?    @map("new_snapshot")
  delta          Json?
  horizonEvalRef String?  @map("horizon_eval_ref")
  modelVersion   String   @map("model_version")
  reason         String?

  state PredictionState @relation(fields: [stateId], references: [id], onDelete: Cascade)

  @@index([stateId, tsCreated(sort: Desc)])
  @@map("predictions_events")
}

model IndicatorSetting {
  id         String   @id @default(uuid())
  scopeType  String   @map("scope_type")
  exchange   String?
  accountId  String?  @map("account_id")
  symbol     String?
  timeframe  String?
  configJson Json     @map("config_json")
  createdAt  DateTime @default(now()) @map("created_at")
  updatedAt  DateTime @updatedAt @map("updated_at")

  @@unique([scopeType, exchange, accountId, symbol, timeframe])
  @@index([scopeType])
  @@index([exchange, accountId, symbol, timeframe])
  @@map("indicator_settings")
}

model LocalStrategyDefinition {
  id           String   @id @default(cuid())
  strategyType String   @map("strategy_type")
  engine       String   @default("ts")
  shadowMode   Boolean  @default(false) @map("shadow_mode")
  newsRiskMode String   @default("off") @map("news_risk_mode")
  remoteStrategyType String? @map("remote_strategy_type")
  fallbackStrategyType String? @map("fallback_strategy_type")
  timeoutMs    Int?     @map("timeout_ms")
  name         String
  description  String?
  version      String
  inputSchema  Json?    @map("input_schema")
  configJson   Json     @map("config_json")
  isEnabled    Boolean  @default(true) @map("is_enabled")
  createdAt    DateTime @default(now()) @map("created_at")
  updatedAt    DateTime @updatedAt @map("updated_at")

  @@index([strategyType, isEnabled, updatedAt(sort: Desc)], map: "local_strategy_type_enabled_updated_idx")
  @@index([isEnabled, updatedAt(sort: Desc)], map: "local_strategy_enabled_updated_idx")
  @@map("local_strategy_definitions")
}

model CompositeStrategy {
  id           String   @id @default(cuid())
  name         String
  description  String?
  version      String
  newsRiskMode String   @default("off") @map("news_risk_mode")
  nodesJson    Json     @map("nodes_json")
  edgesJson    Json     @map("edges_json")
  combineMode  String   @default("pipeline") @map("combine_mode")
  outputPolicy String   @default("local_signal_ai_explain") @map("output_policy")
  isEnabled    Boolean  @default(true) @map("is_enabled")
  createdAt    DateTime @default(now()) @map("created_at")
  updatedAt    DateTime @updatedAt @map("updated_at")

  @@index([isEnabled, updatedAt(sort: Desc)], map: "composite_strategy_enabled_updated_idx")
  @@index([name, updatedAt(sort: Desc)], map: "composite_strategy_name_updated_idx")
  @@map("composite_strategies")
}

model AiTraceLog {
  id                 String   @id @default(cuid())
  userId             String?  @map("user_id")
  user               User?    @relation(fields: [userId], references: [id], onDelete: SetNull)
  scope              String
  provider           String?
  model              String?
  symbol             String?
  marketType         String?  @map("market_type")
  timeframe          String?
  promptTemplateId   String?  @map("prompt_template_id")
  promptTemplateName String?  @map("prompt_template_name")
  systemMessage      String?  @map("system_message")
  userPayload        Json?    @map("user_payload")
  rawResponse        String?  @map("raw_response")
  parsedResponse     Json?    @map("parsed_response")
  success            Boolean  @default(true)
  error              String?
  fallbackUsed       Boolean  @default(false) @map("fallback_used")
  cacheHit           Boolean  @default(false) @map("cache_hit")
  rateLimited        Boolean  @default(false) @map("rate_limited")
  latencyMs          Int?     @map("latency_ms")
  createdAt          DateTime @default(now()) @map("created_at")

  @@index([createdAt(sort: Desc)])
  @@index([scope, createdAt(sort: Desc)])
  @@index([symbol, timeframe, createdAt(sort: Desc)])
  @@index([userId, createdAt(sort: Desc)], map: "ai_trace_logs_user_id_created_at_idx")
  @@map("ai_trace_logs")
}
