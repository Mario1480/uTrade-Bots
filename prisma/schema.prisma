generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model Bot {
  id        String   @id @default(uuid())
  name      String
  symbol    String
  exchange  String
  status    String
  mmEnabled Boolean  @default(true)
  volEnabled Boolean @default(true)
  priceFollowEnabled Boolean @default(false)
  priceSourceExchange String?
  priceSourceSymbol String?
  priceSourceType String @default("TICKER")
  priceSourceMode String @default("CEX")
  dexPriceFeedEnabled Boolean @default(false)
  dexChain String @default("ethereum")
  dexTokenAddress String?
  dexCacheTtlMs Int @default(3000)
  dexStaleAfterMs Int @default(15000)
  dexDeviationEnabled Boolean @default(false)
  dexMaxDeviationBps Int @default(0)
  dexDeviationPolicy String @default("alertOnly")
  dexNotifyCooldownSec Int @default(300)
  createdAt DateTime @default(now())
  workspaceId String?
  workspace   Workspace? @relation(fields: [workspaceId], references: [id])

  mmConfig   MarketMakingConfig?
  volConfig  VolumeConfig?
  riskConfig RiskConfig?
  notificationConfig BotNotificationConfig?
  priceSupportConfig BotPriceSupportConfig?
  runtime    BotRuntime?
  alerts     BotAlert[]
  manualTrades ManualTradeLog[]
  metrics    BotMetric[]
}

model MarketMakingConfig {
  id              String @id @default(uuid())
  botId           String @unique
  bot             Bot    @relation(fields: [botId], references: [id])
  spreadPct       Float
  maxSpreadPct    Float @default(0.0015)
  levelsUp        Int
  levelsDown      Int
  budgetQuoteUsdt Float
  budgetBaseToken Float
  minOrderUsdt    Float @default(5)
  maxOrderUsdt    Float @default(0)
  distribution    String
  jitterPct       Float
  skewFactor      Float
  maxSkew         Float
  mmRepriceMs     Int   @default(15000)
  mmRepricePct    Float @default(0.01)
  mmPriceEpsPct   Float @default(0.005)
  mmQtyEpsPct     Float @default(0.02)
  mmInvAlpha      Float @default(0.1)
}

model VolumeConfig {
  id                String @id @default(uuid())
  botId             String @unique
  bot               Bot    @relation(fields: [botId], references: [id])
  dailyNotionalUsdt Float
  minTradeUsdt      Float
  maxTradeUsdt      Float
  activeFrom        String
  activeTo          String
  mode              String
  buyPct            Float  @default(0.5)
  buyBumpTicks      Float  @default(0)
  sellBumpTicks     Float  @default(0)
  volCooldownMs     Int    @default(60000)
  volActiveTtlMs    Int    @default(20000)
  volMmSafetyMult   Float  @default(1.5)
  volLastBandPct    Float  @default(0.0001)
  volInsideSpreadPct Float @default(0.00005)
  volLastMinBumpAbs Float  @default(0.00000001)
  volLastMinBumpPct Float  @default(0)
  volBuyTicks       Int    @default(2)
  volSellTicks      Int    @default(2)
}

model RiskConfig {
  id              String @id @default(uuid())
  botId           String @unique
  bot             Bot    @relation(fields: [botId], references: [id])
  minUsdt         Float
  maxDeviationPct Float
  maxOpenOrders   Int
  maxDailyLoss    Float
}

model BotNotificationConfig {
  id               String @id @default(uuid())
  botId            String @unique
  bot              Bot    @relation(fields: [botId], references: [id])
  fundsWarnEnabled Boolean @default(true)
  fundsWarnPct     Float   @default(0.1)
}

model BotRuntime {
  botId     String  @id
  bot       Bot     @relation(fields: [botId], references: [id])
  updatedAt DateTime @updatedAt
  status    String
  reason    String?
  lastHealthyAt DateTime?

  mid        Float?
  bid        Float?
  ask        Float?

  // total open orders (all types)
  openOrders Int?

  // separated counts
  openOrdersMm  Int?
  openOrdersVol Int?

  // last passive volume order (clientOrderId like vol-<ts>)
  lastVolClientOrderId String?

  freeUsdt Float?
  freeBase Float?

  tradedNotionalToday Float?

  midCex Float?
  midDex Float?
  dexStatus String?
  dexDiffBps Float?
  dexLastUpdate DateTime?
}

model BotMetric {
  id                  String   @id @default(cuid())
  botId               String
  bot                 Bot      @relation(fields: [botId], references: [id])
  ts                  DateTime @default(now())
  mid                 Float?
  bid                 Float?
  ask                 Float?
  spreadPct           Float?
  openOrders          Int?
  freeQuote           Float?
  freeBase            Float?
  inventoryQuoteValue Float?
  tradedNotionalToday Float?
  mmOrders            Int?
  volOrders           Int?
  status              String?
  reason              String?

  @@index([ts])
  @@index([botId, ts])
}

model CexConfig {
  id        String   @id @default(uuid())
  exchange  String   @unique
  apiKey    String
  apiSecret String
  apiMemo   String?
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

model AlertConfig {
  key               String   @id @default("default")
  telegramBotToken  String?
  telegramChatId    String?
  createdAt         DateTime @default(now())
  updatedAt         DateTime @updatedAt
}

model BotAlert {
  id        String   @id @default(cuid())
  botId     String
  level     String
  title     String
  message   String?
  createdAt DateTime @default(now())
  bot       Bot      @relation(fields: [botId], references: [id])

  @@index([botId, createdAt])
}

model ManualTradeLog {
  id              String   @id @default(cuid())
  workspaceId     String
  userId          String
  botId           String
  symbol          String
  type            String
  side            String
  qty             Float?
  price           Float?
  notional        Float?
  postOnly        Boolean?
  timeInForce     String?
  clientOrderId   String?
  exchangeOrderId String?
  status          String
  error           String?
  createdAt       DateTime @default(now())

  workspace Workspace @relation(fields: [workspaceId], references: [id])
  user      User      @relation(fields: [userId], references: [id])
  bot       Bot       @relation(fields: [botId], references: [id])

  @@index([botId, createdAt])
  @@index([userId, createdAt])
}

model BotFillCursor {
  id                  String   @id @default(cuid())
  botId               String
  symbol              String
  dayKey              String
  tradedNotionalToday Float    @default(0)
  lastTradeTimeMs     BigInt?
  updatedAt           DateTime @updatedAt

  @@unique([botId, symbol, dayKey])
  @@index([botId, symbol, dayKey])
}

model BotFillSeen {
  id        String   @id @default(cuid())
  botId     String
  symbol    String
  tradeId   String
  createdAt DateTime @default(now())

  @@unique([botId, symbol, tradeId])
  @@index([botId, symbol])
}

model BotOrderMap {
  id            String   @id @default(cuid())
  botId         String
  symbol        String
  orderId       String
  clientOrderId String
  createdAt     DateTime @default(now())

  @@unique([botId, symbol, orderId])
  @@index([botId, symbol, clientOrderId])
}

model User {
  id                 String   @id @default(cuid())
  email              String   @unique
  passwordHash       String
  autoLogoutEnabled  Boolean  @default(true)
  autoLogoutMinutes  Int      @default(60)
  allowManualTrading Boolean  @default(false)
  createdAt          DateTime @default(now())
  sessions           Session[]
  reauths            ReauthSession[]
  reauthOtps         ReauthOtp[]
  workspaces         WorkspaceMember[]
  manualTrades       ManualTradeLog[]
  configPresets      BotConfigPreset[]
  auditEvents        AuditEvent[]
}

model Session {
  id           String   @id @default(cuid())
  userId       String
  tokenHash    String   @unique
  createdAt    DateTime @default(now())
  lastActiveAt DateTime @default(now())
  expiresAt    DateTime
  user         User     @relation(fields: [userId], references: [id])

  @@index([userId, expiresAt])
}

model ReauthSession {
  id        String   @id @default(cuid())
  userId    String
  tokenHash String   @unique
  createdAt DateTime @default(now())
  expiresAt DateTime
  user      User     @relation(fields: [userId], references: [id])

  @@index([userId, expiresAt])
}

model ReauthOtp {
  id        String   @id @default(cuid())
  userId    String
  purpose   String
  codeHash  String
  createdAt DateTime @default(now())
  expiresAt DateTime
  user      User     @relation(fields: [userId], references: [id])

  @@index([userId, expiresAt])
}

model Workspace {
  id        String @id @default(cuid())
  name      String
  features  Json? @default("{}")
  createdAt DateTime @default(now())
  members   WorkspaceMember[]
  bots      Bot[]
  manualTrades ManualTradeLog[]
  roles     Role[]
  configPresets BotConfigPreset[]
  auditEvents AuditEvent[]
}

model BotPriceSupportConfig {
  id        String  @id @default(uuid())
  botId     String  @unique
  bot       Bot     @relation(fields: [botId], references: [id])
  enabled   Boolean @default(false)
  active    Boolean @default(true)
  floorPrice Float?
  budgetUsdt Float  @default(0)
  spentUsdt  Float  @default(0)
  maxOrderUsdt Float @default(50)
  cooldownMs Int    @default(2000)
  mode       String @default("PASSIVE")
  lastActionAt BigInt @default(0)
  stoppedReason String?
  notifiedBudgetExhaustedAt BigInt @default(0)
}

model BotConfigPreset {
  id              String   @id @default(cuid())
  workspaceId     String
  name            String
  description     String?
  scope           String   @default("WORKSPACE")
  exchange        String?
  symbol          String?
  payload         Json
  createdByUserId String
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  workspace Workspace @relation(fields: [workspaceId], references: [id])
  createdBy User      @relation(fields: [createdByUserId], references: [id])

  @@unique([workspaceId, name])
  @@index([workspaceId, exchange, symbol])
}

model WorkspaceMember {
  id          String @id @default(cuid())
  workspaceId String
  userId      String
  roleId      String
  status      String @default("ACTIVE")
  createdAt   DateTime @default(now())

  workspace Workspace @relation(fields: [workspaceId], references: [id])
  user      User      @relation(fields: [userId], references: [id])
  role      Role      @relation(fields: [roleId], references: [id])

  @@unique([workspaceId, userId])
  @@index([userId])
  @@index([workspaceId, roleId])
}

model Role {
  id          String   @id @default(cuid())
  workspaceId String
  name        String
  isSystem    Boolean  @default(false)
  permissions Json    @default("{}")
  createdAt   DateTime @default(now())

  workspace Workspace @relation(fields: [workspaceId], references: [id])
  members   WorkspaceMember[]

  @@unique([workspaceId, name])
}

model AuditEvent {
  id          String   @id @default(cuid())
  workspaceId String
  actorUserId String
  action      String
  entityType  String
  entityId    String?
  meta        Json?
  ip          String?
  createdAt   DateTime @default(now())

  workspace Workspace @relation(fields: [workspaceId], references: [id])
  actor     User      @relation(fields: [actorUserId], references: [id])

  @@index([workspaceId, createdAt])
}

model GlobalSetting {
  key       String   @id
  value     Json?
  updatedAt DateTime @updatedAt
}

model RunnerStatus {
  id          String   @id @default("main")
  updatedAt   DateTime @updatedAt
  lastTickAt  DateTime
  botsRunning Int
  botsErrored Int
  version     String?
}
