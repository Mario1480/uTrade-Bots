map $http_authorization $salad_api_key {
    default "";
    ~*^Bearer\s+(.+)$ $1;
}

server {
    listen 8088;
    server_name _;
    resolver 127.0.0.11 ipv6=off valid=300s;
    resolver_timeout 5s;

    location = /health {
        default_type text/plain;
        return 200 "ok";
    }

    location = /v1/chat/completions {
        set $salad_upstream beet-ambrosia-una2kb4n1u45see3.salad.cloud;
        proxy_pass https://$salad_upstream/api/chat;
        proxy_http_version 1.1;
        proxy_set_header Content-Type application/json;
        proxy_set_header Accept application/json;
        proxy_set_header Host $salad_upstream;
        proxy_set_header Salad-Api-Key $salad_api_key;
        proxy_set_header Authorization "";
        proxy_ssl_server_name on;
        proxy_ssl_name $salad_upstream;
        proxy_buffering off;
        proxy_request_buffering off;
        proxy_read_timeout 180s;
        proxy_send_timeout 180s;
    }
}
